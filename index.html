<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smoke Shop Accessories | Dallas Wholesale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #f9fafb; min-height: 100vh; font-family: sans-serif; }
        .hidden { display: none; }
        .cart-count { position: absolute; top: -5px; right: -10px; background: #ef4444; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; font-weight: bold; }
        .loader { border-top-color: #059669; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="ageGate" class="fixed inset-0 z-[100] bg-black flex items-center justify-center p-6 text-center">
        <div class="bg-white p-10 rounded-3xl max-w-sm border-b-8 border-green-600 shadow-2xl">
            <h1 class="text-2xl font-black text-green-800 mb-6 uppercase italic tracking-tighter">Smoke Shop Accessories</h1>
            <p class="mb-8 font-bold text-gray-400 uppercase tracking-widest">Age Verification</p>
            <button onclick="enterSite()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-black text-xl hover:bg-black transition shadow-lg tracking-tight">I AM 21+</button>
        </div>
    </div>

    <div id="accessGate" class="hidden fixed inset-0 z-[90] bg-green-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl max-w-md w-full shadow-2xl border border-green-100">
            <h2 class="text-2xl font-black text-center text-green-900 mb-6 uppercase">Customer Access</h2>
            <div id="loginForm">
                <input id="loginEmail" type="email" placeholder="Enter Email" class="w-full p-4 border rounded-2xl mb-4 outline-none focus:ring-2 focus:ring-green-500">
                <button onclick="login()" class="w-full bg-green-700 text-white py-4 rounded-2xl font-black hover:bg-black transition mb-6">LOGIN</button>
                <p class="text-center text-sm text-gray-500">New customer? <button onclick="toggleAccess('reg')" class="text-green-600 font-bold underline">Create Account</button></p>
            </div>
            <div id="regForm" class="hidden">
                <input id="regName" placeholder="Full Name *" class="w-full p-4 border rounded-2xl mb-3 outline-none"><input id="regPhone" placeholder="Phone *" class="w-full p-4 border rounded-2xl mb-3 outline-none"><input id="regEmail" placeholder="Email *" class="w-full p-4 border rounded-2xl mb-3 outline-none"><input id="regTax" placeholder="Tax ID (Wholesale only)" class="w-full p-4 border rounded-2xl mb-4 outline-none">
                <button onclick="register()" class="w-full bg-black text-white py-4 rounded-2xl font-black hover:bg-green-700 transition">REGISTER & SHOP</button>
                <button onclick="toggleAccess('login')" class="w-full text-xs text-gray-400 mt-4 underline uppercase">Back to Login</button>
            </div>
        </div>
    </div>

    <div id="app" class="hidden">
        <header class="bg-white/95 backdrop-blur-md sticky top-0 z-50 border-b border-green-100 p-4">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3 cursor-pointer group" onclick="goHome()">
                    <div class="w-10 h-10 bg-green-700 rounded-lg flex items-center justify-center text-white font-bold text-xl">S</div>
                    <div>
                        <h1 class="text-sm font-black text-green-900 uppercase italic leading-none group-hover:text-green-600">Smoke Shop Accessories</h1>
                        <p id="welcomeUser" class="text-[9px] font-bold text-green-600 mt-1 uppercase"></p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <input type="text" id="search" onkeyup="render()" placeholder="Search..." class="px-4 py-2 border rounded-full text-sm w-32 sm:w-64 outline-none focus:border-green-600">
                    <div class="relative cursor-pointer" onclick="toggleCart()"><span class="text-2xl">ðŸ›’</span><span id="cartCount" class="cart-count">0</span></div>
                    <button onclick="logout()" class="text-[10px] font-bold text-red-500 underline uppercase">Logout</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-10">
            <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="col-span-full text-center py-20">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto mb-4"></div>
                    <p class="font-bold text-green-800" id="statusMsg">SYNCING INVENTORY...</p>
                </div>
            </div>
        </main>
    </div>

    <div id="cartModal" class="hidden fixed inset-0 z-[110] bg-black/60 flex justify-end">
        <div class="bg-white w-full max-w-md h-full p-6 flex flex-col shadow-2xl">
            <div class="flex justify-between items-center mb-6 border-b pb-4"><h2 class="text-2xl font-black text-green-900 uppercase italic">Your Order</h2><button onclick="toggleCart()" class="text-3xl">&times;</button></div>
            <div id="cartItems" class="flex-grow overflow-y-auto space-y-4"></div>
            <div class="border-t pt-6 mt-6">
                <div class="flex justify-between text-xl font-black mb-6"><span>TOTAL:</span><span id="cartTotal" class="text-green-700">$0.00</span></div>
                <button onclick="submitOrder()" id="orderBtn" class="w-full bg-green-600 text-white py-5 rounded-2xl font-black text-lg hover:bg-black transition uppercase italic tracking-tighter">Confirm & Send Order</button>
            </div>
        </div>
    </div>

    <script>
        let products = []; let wholesale = []; let cart = [];
        let activeUser = JSON.parse(localStorage.getItem('ss_user')) || null;
        
        // PASTE YOUR NEW LINK HERE
        const SCRIPT_URL ="https://script.google.com/macros/s/AKfycbw_ntPTHQXVkrYjiFP9-PuqnfD1teJgTnQyT4j4uT0y79mwOE3fW6i_o2KxVjvhkWbj/exec";

        function enterSite() {
            document.getElementById('ageGate').classList.add('hidden');
            if (activeUser) { document.getElementById('app').classList.remove('hidden'); fetchData(); } 
            else { document.getElementById('accessGate').classList.remove('hidden'); }
        }

        async function fetchData() {
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                if(data.error) throw new Error(data.error);
                products = data.products; wholesale = data.wholesale;
                document.getElementById('welcomeUser').innerText = `Logged in: ${activeUser.email}`;
                render();
            } catch (e) {
                document.getElementById('statusMsg').innerHTML = "Connection Error. Please ensure Script is deployed to 'Anyone'.";
            }
        }

        function goHome() { document.getElementById('search').value = ""; render(); window.scrollTo(0,0); }
        function toggleAccess(t) { document.getElementById('loginForm').classList.toggle('hidden', t === 'reg'); document.getElementById('regForm').classList.toggle('hidden', t === 'login'); }
        function login() { const e = document.getElementById('loginEmail').value.toLowerCase().trim(); if(!e) return; activeUser = { email: e, name: e.split('@')[0], taxId: "" }; saveAndEnter(); }
        async function register() {
            const d = { type: "registration", name: document.getElementById('regName').value, phone: document.getElementById('regPhone').value, email: document.getElementById('regEmail').value.toLowerCase().trim(), taxId: document.getElementById('regTax').value };
            if(!d.email) return; await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(d) }); activeUser = d; saveAndEnter();
        }
        function saveAndEnter() { localStorage.setItem('ss_user', JSON.stringify(activeUser)); location.reload(); }
        function logout() { localStorage.removeItem('ss_user'); location.reload(); }

        function render() {
            const q = document.getElementById('search').value.toLowerCase();
            const g = document.getElementById('grid');
            const f = products.filter(p => p[0].toString().toLowerCase().includes(q) || p[1].toString().toLowerCase().includes(q));
            
            g.innerHTML = f.map(p => {
                let [n, s, r, w, img] = p;
                let price = (activeUser.taxId) ? w : r;
                let tag = (activeUser.taxId) ? "WHOLESALE" : "RETAIL";
                let vip = wholesale.find(v => v[0].toLowerCase() === activeUser.email && v[1] === n);
                if(vip) { price = vip[2]; tag = "VIP"; }

                return `<div class="bg-white p-5 rounded-3xl border border-gray-100 shadow-sm hover:shadow-xl transition-all">
                    <img src="${img || 'https://via.placeholder.com/400'}" class="w-full h-44 object-cover rounded-2xl mb-4">
                    <div class="flex justify-between items-center mb-1"><span class="text-[9px] font-black text-green-600 uppercase tracking-widest">${s}</span><span class="text-[8px] font-bold text-gray-400 border px-2 py-0.5 rounded-full">${tag}</span></div>
                    <h3 class="font-bold text-gray-800 text-sm h-10 overflow-hidden uppercase leading-tight">${n}</h3>
                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-50"><p class="text-xl font-black text-green-700">$${price}</p><button onclick="addToCart('${n}', ${price})" class="bg-black text-white px-5 py-2 rounded-xl text-xs font-black hover:bg-green-600">+ ADD</button></div>
                </div>`;
            }).join('');
        }

        function addToCart(n, p) { const i = cart.find(x => x.name === n); if(i) i.qty++; else cart.push({ name: n, price: p, qty: 1 }); updateCartUI(); }
        function updateCartUI() {
            document.getElementById('cartCount').innerText = cart.reduce((a, b) => a + b.qty, 0);
            const c = document.getElementById('cartItems'); let t = 0;
            c.innerHTML = cart.map((x, idx) => { t += x.price * x.qty; return `<div class="flex justify-between items-center bg-gray-50 p-4 rounded-2xl"><div><p class="font-bold text-xs uppercase">${x.name}</p><p class="text-xs font-black text-green-700">$${x.price}</p></div><div class="flex items-center gap-2"><input type="number" value="${x.qty}" onchange="updateQty(${idx}, this.value)" class="w-10 border rounded p-1 text-center text-xs"><button onclick="removeItem(${idx})" class="text-red-500 font-bold">Ã—</button></div></div>` }).join('');
            document.getElementById('cartTotal').innerText = `$${t.toFixed(2)}`;
        }
        function updateQty(idx, v) { cart[idx].qty = Math.max(1, parseInt(v)); updateCartUI(); }
        function removeItem(idx) { cart.splice(idx, 1); updateCartUI(); }
        function toggleCart() { document.getElementById('cartModal').classList.toggle('hidden'); updateCartUI(); }

        async function submitOrder() {
            if(!cart.length) return; const btn = document.getElementById('orderBtn'); btn.disabled = true; btn.innerText = "SENDING...";
            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ type: "order", customerName: activeUser.name, email: activeUser.email, customerType: (activeUser.taxId ? "Wholesale" : "Retail"), items: cart }) });
                alert("Order Placed! Dallas HQ will contact you."); cart = []; updateCartUI(); toggleCart();
            } catch (e) { alert("Failed to send order."); } finally { btn.disabled = false; btn.innerText = "Confirm & Send Order"; }
        }
    </script>
</body>
</html>
