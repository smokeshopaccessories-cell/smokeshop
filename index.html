<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smoke Shop Accessories | Dallas Wholesale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #f9fafb; min-height: 100vh; font-family: sans-serif; }
        .hidden { display: none; }
        .cart-count { position: absolute; top: -5px; right: -10px; background: #ef4444; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; font-weight: bold; }
        .loader { border-top-color: #059669; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="ageGate" class="fixed inset-0 z-[100] bg-black flex items-center justify-center p-6 text-center">
        <div class="bg-white p-10 rounded-3xl max-w-sm border-b-8 border-green-600 shadow-2xl">
            <img src="logo.png" alt="Smoke Shop Accessories" class="w-full mb-6" onerror="this.src='https://via.placeholder.com/300x150?text=SMOKE+SHOP'">
            <p class="mb-8 font-bold text-gray-500 uppercase tracking-widest">Age Verification</p>
            <button onclick="enterSite()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-black text-xl hover:bg-black transition shadow-lg">I AM 21+</button>
        </div>
    </div>

    <div id="accessGate" class="hidden fixed inset-0 z-[90] bg-green-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl max-w-md w-full shadow-2xl border border-green-100">
            <img src="logo.png" class="h-12 mx-auto mb-6" onerror="this.src='https://via.placeholder.com/200x80?text=LOGO'">
            <h2 class="text-2xl font-black text-center text-green-900 mb-6 uppercase">Customer Access</h2>
            
            <div id="loginForm">
                <p class="text-xs text-gray-500 mb-2 font-bold uppercase">Already Registered?</p>
                <input id="loginEmail" type="email" placeholder="Enter Email" class="w-full p-4 border rounded-2xl mb-4 outline-none focus:ring-2 focus:ring-green-500">
                <button onclick="login()" class="w-full bg-green-700 text-white py-4 rounded-2xl font-black hover:bg-black transition mb-6">LOGIN</button>
                <hr class="mb-6">
                <p class="text-center text-sm">New to Smoke Shop Accessories?<br>
                <button onclick="toggleAccess('reg')" class="text-green-600 font-bold underline mt-2">Create Account to Order</button></p>
            </div>

            <div id="regForm" class="hidden">
                <p class="text-xs text-gray-500 mb-4 font-bold uppercase">Required for Retail & Wholesale</p>
                <input id="regName" placeholder="Full Name *" class="w-full p-4 border rounded-2xl mb-3 outline-none">
                <input id="regPhone" placeholder="Phone Number *" class="w-full p-4 border rounded-2xl mb-3 outline-none">
                <input id="regEmail" placeholder="Email Address *" class="w-full p-4 border rounded-2xl mb-3 outline-none">
                <input id="regTax" placeholder="Tax ID (Leave empty for Retail)" class="w-full p-4 border rounded-2xl mb-4 outline-none">
                <button onclick="register()" class="w-full bg-black text-white py-4 rounded-2xl font-black hover:bg-green-700 transition">REGISTER & SHOP</button>
                <button onclick="toggleAccess('login')" class="w-full text-xs text-gray-400 mt-4 underline uppercase">Back to Login</button>
            </div>
        </div>
    </div>

    <div id="app" class="hidden">
        <header class="bg-white/95 backdrop-blur-md sticky top-0 z-50 border-b border-green-100 p-4">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3 cursor-pointer" onclick="goHome()">
                    <img src="logo.png" alt="Logo" class="h-10 w-auto" onerror="this.src='https://via.placeholder.com/40x40?text=S'">
                    <div class="hidden sm:block">
                        <h1 class="text-sm font-black text-green-900 uppercase italic leading-none">Smoke Shop Accessories</h1>
                        <p id="welcomeUser" class="text-[9px] font-bold text-green-600 mt-1 uppercase"></p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <input type="text" id="search" onkeyup="render()" placeholder="Search Products..." class="px-4 py-2 border rounded-full text-sm w-32 sm:w-64 outline-none focus:border-green-600">
                    <div class="relative cursor-pointer" onclick="toggleCart()">
                        <span class="text-2xl">ðŸ›’</span>
                        <span id="cartCount" class="cart-count">0</span>
                    </div>
                    <button onclick="logout()" class="text-[10px] font-black text-red-500 underline uppercase">Logout</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-10">
            <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="col-span-full text-center py-20">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto mb-4"></div>
                    <p class="font-bold text-green-800" id="statusText">LOADING DALLAS INVENTORY...</p>
                </div>
            </div>
        </main>
    </div>

    <div id="cartModal" class="hidden fixed inset-0 z-[110] bg-black/60 flex justify-end">
        <div class="bg-white w-full max-w-md h-full p-6 flex flex-col">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-2xl font-black text-green-900 uppercase">Your Order</h2>
                <button onclick="toggleCart()" class="text-3xl font-light">&times;</button>
            </div>
            
            <div id="cartItems" class="flex-grow overflow-y-auto space-y-4"></div>

            <div class="border-t pt-6 mt-6">
                <div class="flex justify-between text-xl font-black mb-6">
                    <span>ESTIMATED TOTAL:</span>
                    <span id="cartTotal" class="text-green-700">$0.00</span>
                </div>
                <button onclick="submitOrder()" class="w-full bg-green-600 text-white py-5 rounded-2xl font-black text-lg hover:bg-black transition">CONFIRM & SEND ORDER</button>
                <p class="text-[10px] text-center text-gray-400 mt-4 uppercase">Prices subject to verification at store</p>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        let wholesale = [];
        let cart = [];
        let activeUser = JSON.parse(localStorage.getItem('ss_user')) || null;
        
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzTF2CIP6ZCMVs-dHok75yzs_MqmafQNyj5qydglXQVRla8SGygHWWA0AtajV9mUyTi/exec";

        function enterSite() {
            document.getElementById('ageGate').classList.add('hidden');
            if (activeUser) { 
                document.getElementById('app').classList.remove('hidden'); 
                fetchData(); 
            } else { 
                document.getElementById('accessGate').classList.remove('hidden'); 
            }
        }

        async function fetchData() {
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                products = data.products || [];
                wholesale = data.wholesale || [];
                document.getElementById('welcomeUser').innerText = `Customer: ${activeUser.name || activeUser.email}`;
                render();
            } catch (e) {
                document.getElementById('statusText').innerText = "Inventory Offline. Please refresh page.";
            }
        }

        function goHome() {
            document.getElementById('search').value = "";
            render();
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function login() {
            const email = document.getElementById('loginEmail').value.toLowerCase().trim();
            if(!email) return alert("Enter your email address");
            // Defaulting name for login; real name will sync if they registered
            activeUser = { email: email, name: email.split('@')[0], taxId: "" };
            saveAndEnter();
        }

        async function register() {
            const data = {
                type: "registration",
                name: document.getElementById('regName').value,
                phone: document.getElementById('regPhone').value,
                email: document.getElementById('regEmail').value.toLowerCase().trim(),
                taxId: document.getElementById('regTax').value
            };
            if(!data.name || !data.phone || !data.email) return alert("Please fill out Name, Phone, and Email.");
            
            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
                activeUser = data;
                saveAndEnter();
            } catch (e) { alert("Registration failed."); }
        }

        function saveAndEnter() {
            localStorage.setItem('ss_user', JSON.stringify(activeUser));
            location.reload();
        }

        function logout() { localStorage.removeItem('ss_user'); location.reload(); }

        function render() {
            const query = document.getElementById('search').value.toLowerCase();
            const grid = document.getElementById('grid');
            if (!products.length) return;

            const filtered = products.filter(p => p[0].toString().toLowerCase().includes(query) || p[1].toString().toLowerCase().includes(query));

            grid.innerHTML = filtered.map(p => {
                let [name, style, retail, wholesalePrice, img] = p;
                
                // Wholesale if they have a Tax ID, otherwise Retail
                let userPrice = (activeUser.taxId && activeUser.taxId.trim() !== "") ? wholesalePrice : retail;
                let tag = (activeUser.taxId && activeUser.taxId.trim() !== "") ? "WHOLESALE" : "RETAIL";

                // Check for individual VIP price override in WholesalePrices tab
                let custom = wholesale.find(w => w[0].toLowerCase() === activeUser.email && w[1] === name);
                if(custom) { userPrice = custom[2]; tag = "VIP"; }

                return `
                <div class="bg-white p-5 rounded-3xl border border-gray-100 shadow-sm hover:shadow-xl transition-all">
                    <img src="${img || 'https://via.placeholder.com/400?text='+name}" class="w-full h-44 object-cover rounded-2xl mb-4 shadow-inner" onerror="this.src='https://via.placeholder.com/400?text=Image+Coming+Soon'">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[9px] font-black text-green-600 uppercase tracking-widest">${style}</span>
                        <span class="text-[8px] font-bold text-gray-400 border px-2 py-0.5 rounded-full">${tag}</span>
                    </div>
                    <h3 class="font-bold text-gray-800 text-sm h-10 overflow-hidden uppercase leading-tight">${name}</h3>
                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-50">
                        <p class="text-xl font-black text-green-700">$${userPrice}</p>
                        <button onclick="addToCart('${name}', ${userPrice})" class="bg-black text-white px-5 py-2 rounded-xl text-xs font-black hover:bg-green-600 transition">+ ADD</button>
                    </div>
                </div>`;
            }).join('');
        }

        function addToCart(name, price) {
            const item = cart.find(i => i.name === name);
            if(item) { item.qty++; } else { cart.push({ name, price, qty: 1 }); }
            updateCartUI();
        }

        function updateCartUI() {
            document.getElementById('cartCount').innerText = cart.reduce((a, b) => a + b.qty, 0);
            const container = document.getElementById('cartItems');
            let total = 0;
            
            if(cart.length === 0) {
                container.innerHTML = `<p class="text-center py-20 text-gray-400 italic">Your order is empty</p>`;
            } else {
                container.innerHTML = cart.map((item, index) => {
                    total += item.price * item.qty;
                    return `
                    <div class="flex justify-between items-center bg-gray-50 p-4 rounded-2xl">
                        <div class="flex-1 pr-4">
                            <p class="font-bold text-xs uppercase text-gray-800">${item.name}</p>
                            <p class="text-xs font-black text-green-700 mt-1">$${item.price} each</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <input type="number" min="1" value="${item.qty}" onchange="updateQty(${index}, this.value)" class="w-12 border rounded-lg p-1 text-center font-bold text-xs">
                            <button onclick="removeItem(${index})" class="text-red-500 font-bold text-xl">&times;</button>
                        </div>
                    </div>`;
                }).join('');
            }
            document.getElementById('cartTotal').innerText = `$${total.toFixed(2)}`;
        }

        function updateQty(index, val) { 
            if(val < 1) val = 1;
            cart[index].qty = parseInt(val); 
            updateCartUI(); 
        }

        function removeItem(index) { cart.splice(index, 1); updateCartUI(); }
        
        function toggleCart() { 
            document.getElementById('cartModal').classList.toggle('hidden');
            updateCartUI();
        }

        async function submitOrder() {
            if(cart.length === 0) return alert("Your order is empty.");
            
            const btn = event.target;
            btn.innerText = "SENDING ORDER...";
            btn.disabled = true;

            const orderPayload = {
                type: "order",
                customerName: activeUser.name,
                email: activeUser.email,
                customerType: (activeUser.taxId) ? "Wholesale" : "Retail",
                items: cart
            };
            
            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(orderPayload) });
                alert("Order submitted successfully! Our Dallas team will contact you shortly.");
                cart = [];
                updateCartUI();
                toggleCart();
            } catch (e) { 
                alert("Order failed to send. Check your internet connection."); 
            } finally {
                btn.innerText = "CONFIRM & SEND ORDER";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
